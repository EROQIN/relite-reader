import { createContext, useContext, useEffect, useMemo, useState } from 'react'
import { detectLocale, getStoredLocale, Locale, saveLocale } from '../lib/i18n'

type I18nContextValue = {
  locale: Locale
  setLocale: (locale: Locale) => void
  t: (key: string, vars?: Record<string, string | number>) => string
}

const I18nContext = createContext<I18nContextValue | null>(null)

const translations: Record<Locale, Record<string, string>> = {
  en: {
    'nav.library': 'Library',
    'nav.webdav': 'WebDAV',
    'nav.login': 'Login',
    'nav.logout': 'Log out',
    'nav.brand': 'Relite Reader',
    'nav.localeToggle': 'Switch language',
    'auth.overline': 'Account',
    'auth.title.login': 'Sign in',
    'auth.title.register': 'Create account',
    'auth.helper.login': 'Use your Relite account to sync preferences across devices.',
    'auth.helper.register': 'Create a Relite account to save preferences and progress.',
    'auth.toggle.register': 'Need an account?',
    'auth.toggle.login': 'Have an account?',
    'auth.label.email': 'Email',
    'auth.label.password': 'Password',
    'auth.placeholder.email': 'you@example.com',
    'auth.submit.loading': 'Working...',
    'auth.submit.login': 'Sign in',
    'auth.submit.register': 'Create account',
    'auth.message.missing': 'Please enter both email and password.',
    'auth.message.success': 'Signed in successfully. You can return to your library.',
    'auth.message.error': 'Unable to sign in. Check your credentials or try again.',
    'auth.footnote': 'Local-only reading is available without login.',
    'library.overline': 'Relite Reader',
    'library.hero.title': 'Curate your quiet library.',
    'library.hero.subtitle': 'Blend local files and WebDAV shelves into a single reading space.',
    'library.hero.import': 'Import',
    'library.webdav.title': 'WebDAV Library',
    'library.webdav.subtitle': 'Connect to sync your remote shelves.',
    'library.local.title': 'Local Imports',
    'library.local.subtitle': 'Search and revisit your local titles.',
    'library.local.empty': 'No local books yet.',
    'library.local.emptySearch': 'No matches. Try a different keyword.',
    'library.search.placeholder': 'Search by title, author, or format',
    'library.search.label': 'Search library',
    'library.item.lastOpened': 'Last opened {time}',
    'library.item.progress': 'Progress {percent}%',
    'library.item.open': 'Open',
    'library.item.remove': 'Remove',
    'tasks.title': 'Format queue',
    'tasks.subtitle': 'Unsupported formats are processed in the background.',
    'tasks.viewAll': 'View all',
    'tasks.refresh': 'Refresh',
    'tasks.refreshing': 'Refreshing...',
    'tasks.retry': 'Retry',
    'tasks.retrying': 'Retrying...',
    'tasks.auth': 'Sign in to see queued conversions.',
    'tasks.empty': 'No queued tasks right now.',
    'tasks.error': 'Unable to load the task queue.',
    'tasks.page.overline': 'Queue',
    'tasks.page.title': 'Format Task Queue',
    'tasks.page.subtitle': 'Track background conversions and format preparation.',
    'tasks.filter.all': 'All',
    'tasks.filter.queued': 'Queued',
    'tasks.filter.running': 'Processing',
    'tasks.filter.success': 'Ready',
    'tasks.filter.error': 'Failed',
    'tasks.status.queued': 'Queued',
    'tasks.status.running': 'Processing',
    'tasks.status.success': 'Ready',
    'tasks.status.error': 'Failed',
    'tasks.item.format': '{format} conversion',
    'tasks.item.generic': 'Background task',
    'tasks.item.source': 'Source: {source}',
    'tasks.item.book': 'Book ID: {id}',
    'tasks.item.bookTitle': 'Book: {title}',
    'webdav.title': 'WebDAV Library',
    'webdav.signin.helper': 'Sign in to manage your WebDAV connections.',
    'webdav.signin.cta': 'Go to login',
    'webdav.overline': 'Storage',
    'webdav.subtitle': 'Add your WebDAV server to index and stream your library.',
    'webdav.refresh': 'Refresh',
    'webdav.form.add': 'Add connection',
    'webdav.form.edit': 'Edit connection',
    'webdav.form.baseUrl': 'Base URL',
    'webdav.form.baseUrl.placeholder': 'https://dav.example.com/remote.php/dav/files/user',
    'webdav.form.username': 'Username',
    'webdav.form.username.placeholder': 'user',
    'webdav.form.secret': 'Password / app token',
    'webdav.form.secret.placeholder': '••••••••',
    'webdav.form.save': 'Save connection',
    'webdav.form.update': 'Update connection',
    'webdav.form.cancel': 'Cancel edit',
    'webdav.form.tip': 'Tip: Some providers require an app-specific password.',
    'webdav.list.title': 'Connections',
    'webdav.list.loading': 'Loading...',
    'webdav.list.empty': 'No connections yet. Add one to get started.',
    'webdav.list.lastSync': 'Last sync {time}',
    'webdav.action.sync': 'Sync',
    'webdav.action.edit': 'Edit',
    'webdav.action.remove': 'Remove',
    'webdav.status.idle': 'idle',
    'webdav.status.success': 'success',
    'webdav.status.error': 'error',
    'webdav.status.syncing': 'syncing',
    'webdav.message.loadError': 'Unable to load WebDAV connections.',
    'webdav.message.saveError': 'Unable to save connection. Please check the details.',
    'webdav.message.removeError': 'Unable to remove this connection.',
    'webdav.message.syncStart': 'Sync started. Refresh in a moment to see updates.',
    'webdav.message.syncError': 'Unable to start sync.',
    'reader.quick.theme': 'Theme',
    'reader.quick.layout': 'Layout',
    'reader.quick.focus': 'Focus',
    'reader.quick.settings': 'Settings',
    'reader.controls.title': 'Customize',
    'reader.controls.reset': 'Reset',
    'reader.controls.preset': 'Preset',
    'reader.controls.preset.custom': 'Custom',
    'reader.controls.customPresets.title': 'Custom presets',
    'reader.controls.customPresets.subtitle': 'Save your current setup.',
    'reader.controls.customPresets.placeholder': 'Preset name',
    'reader.controls.customPresets.save': 'Save',
    'reader.controls.customPresets.empty': 'No custom presets yet.',
    'reader.controls.customPresets.apply': 'Apply',
    'reader.controls.customPresets.rename': 'Rename',
    'reader.controls.customPresets.delete': 'Delete',
    'reader.controls.scope': 'Apply to this book',
    'reader.controls.theme.label': 'Theme',
    'reader.controls.theme.paper': 'Paper',
    'reader.controls.theme.sepia': 'Sepia',
    'reader.controls.theme.night': 'Night',
    'reader.controls.theme.slate': 'Slate',
    'reader.controls.theme.mist': 'Mist',
    'reader.controls.background.title': 'Background',
    'reader.controls.background.subtitle': 'Override the theme if you want a custom tone.',
    'reader.controls.background.swatch': 'Background {label}',
    'reader.controls.background.custom': 'Custom background color',
    'reader.controls.background.useTheme': 'Use theme',
    'reader.controls.brightness': 'Brightness',
    'reader.controls.font.label': 'Font',
    'reader.controls.font.serif': 'Serif',
    'reader.controls.font.sans': 'Sans',
    'reader.controls.font.mono': 'Mono',
    'reader.controls.fontSize': 'Font size',
    'reader.controls.lineHeight': 'Line height',
    'reader.controls.readingPace': 'Reading pace',
    'reader.controls.readingPace.value': '{value} wpm',
    'reader.controls.pageWidth': 'Page width',
    'reader.controls.alignment.label': 'Alignment',
    'reader.controls.alignment.left': 'Left',
    'reader.controls.alignment.justify': 'Justify',
    'reader.controls.layout.label': 'Layout',
    'reader.controls.layout.single': 'Single',
    'reader.controls.layout.columns': 'Columns',
    'reader.controls.focusMode': 'Focus mode',
    'reader.presets.paper': 'Paper Focus',
    'reader.presets.sepia': 'Sepia Calm',
    'reader.presets.night': 'Night Studio',
    'reader.presets.slate': 'Slate Focus',
    'reader.presets.mist': 'Mist Daylight',
    'reader.presets.comfort': 'Comfort Plus',
    'reader.meta.time': '{left} min left · {total} min total',
    'reader.progress.label': 'Reading progress',
    'reader.text.empty': 'No text content found.',
    'reader.bookmarks.title': 'Bookmarks',
    'reader.bookmarks.subtitle': 'Save spots to jump back later.',
    'reader.bookmarks.label': 'Bookmark label',
    'reader.bookmarks.placeholder': 'Bookmark label',
    'reader.bookmarks.add': 'Add',
    'reader.bookmarks.empty': 'No bookmarks yet.',
    'reader.bookmarks.remove': 'Remove',
    'reader.bookmarks.defaultLabel': 'Bookmark {percent}%',
    'reader.page.overline': 'Reader',
    'reader.page.title': 'Reading Studio',
    'reader.page.shortcuts': 'Shortcuts',
    'reader.page.settings': 'Settings',
    'reader.page.exitFocus': 'Exit focus',
    'reader.shell.notFound': 'Book not found.',
    'reader.format.epub': 'EPUB reader for {title}',
    'reader.format.pdf': 'PDF reader for {title}',
    'reader.format.mobi': 'MOBI reader for {title}. If parsing fails, use server conversion.',
    'reader.shortcuts.aria': 'Reader shortcuts',
    'reader.shortcuts.title': 'Keyboard Shortcuts',
    'reader.shortcuts.close': 'Close',
    'reader.shortcuts.hint': 'Press Escape to close.',
    'reader.shortcuts.cycleTheme': 'Cycle theme',
    'reader.shortcuts.toggleLayout': 'Toggle layout',
    'reader.shortcuts.focusMode': 'Focus mode',
    'reader.shortcuts.settings': 'Settings panel',
    'reader.shortcuts.increaseFont': 'Increase font',
    'reader.shortcuts.decreaseFont': 'Decrease font',
    'reader.shortcuts.show': 'Show shortcuts',
    'placeholder.format': 'Format: {format}',
    'placeholder.comic': 'Comic archive detected. Rendering support is queued.',
    'placeholder.kindle': 'Kindle format detected. Conversion support is queued.',
    'placeholder.fb2': 'FictionBook format detected. Parsing support is queued.',
    'placeholder.rtf': 'Rich Text format detected. Parsing support is queued.',
    'placeholder.docx': 'Word document detected. Parsing support is queued.',
    'placeholder.markdown': 'Markdown document detected. Rendering support is queued.',
    'placeholder.html': 'HTML document detected. Rendering support is queued.',
    'placeholder.odt': 'OpenDocument text detected. Rendering support is queued.',
    'placeholder.djvu': 'DjVu document detected. Rendering support is queued.',
    'placeholder.xps': 'XPS document detected. Rendering support is queued.',
    'placeholder.lit': 'Legacy Microsoft Reader format detected. Conversion support is queued.',
    'placeholder.pdb': 'PalmDOC format detected. Conversion support is queued.',
    'placeholder.unsupported': 'This format is not yet supported.',
    'placeholder.note': 'Your file is indexed and safe. We will notify you once rendering is ready.',
    'pwa.title': 'Install Relite Reader',
    'pwa.description.install': 'Add this app to your home screen for offline-friendly reading.',
    'pwa.description.ios': 'On iOS Safari, tap Share → Add to Home Screen.',
    'pwa.action.install': 'Install',
    'pwa.action.dismiss': 'Dismiss',
  },
  'zh-CN': {
    'nav.library': '书库',
    'nav.webdav': 'WebDAV',
    'nav.login': '登录',
    'nav.logout': '退出',
    'nav.brand': 'Relite Reader',
    'nav.localeToggle': '切换语言',
    'auth.overline': '账号',
    'auth.title.login': '登录',
    'auth.title.register': '创建账号',
    'auth.helper.login': '使用 Relite 账号同步偏好设置。',
    'auth.helper.register': '创建 Relite 账号以保存偏好与进度。',
    'auth.toggle.register': '需要账号？',
    'auth.toggle.login': '已有账号？',
    'auth.label.email': '邮箱',
    'auth.label.password': '密码',
    'auth.placeholder.email': 'you@example.com',
    'auth.submit.loading': '处理中…',
    'auth.submit.login': '登录',
    'auth.submit.register': '创建账号',
    'auth.message.missing': '请输入邮箱和密码。',
    'auth.message.success': '登录成功，可返回书库。',
    'auth.message.error': '登录失败，请检查凭据或稍后再试。',
    'auth.footnote': '无需登录也可本地阅读。',
    'library.overline': 'Relite Reader',
    'library.hero.title': '整理你的安静书库。',
    'library.hero.subtitle': '将本地文件与 WebDAV 书架整合到同一阅读空间。',
    'library.hero.import': '导入',
    'library.webdav.title': 'WebDAV 书库',
    'library.webdav.subtitle': '连接以同步远程书架。',
    'library.local.title': '本地导入',
    'library.local.subtitle': '搜索并快速打开本地图书。',
    'library.local.empty': '暂无本地图书。',
    'library.local.emptySearch': '没有匹配结果，请尝试其他关键词。',
    'library.search.placeholder': '按标题、作者或格式搜索',
    'library.search.label': '搜索书库',
    'library.item.lastOpened': '上次打开 {time}',
    'library.item.progress': '进度 {percent}%',
    'library.item.open': '打开',
    'library.item.remove': '移除',
    'tasks.title': '格式转换队列',
    'tasks.subtitle': '不支持的格式将进入后台转换。',
    'tasks.viewAll': '查看全部',
    'tasks.refresh': '刷新',
    'tasks.refreshing': '刷新中...',
    'tasks.retry': '重试',
    'tasks.retrying': '重试中...',
    'tasks.auth': '登录后可查看转换队列。',
    'tasks.empty': '当前没有排队任务。',
    'tasks.error': '无法加载任务队列。',
    'tasks.page.overline': '队列',
    'tasks.page.title': '格式任务队列',
    'tasks.page.subtitle': '查看后台格式转换与准备进度。',
    'tasks.filter.all': '全部',
    'tasks.filter.queued': '排队中',
    'tasks.filter.running': '处理中',
    'tasks.filter.success': '已就绪',
    'tasks.filter.error': '失败',
    'tasks.status.queued': '排队中',
    'tasks.status.running': '处理中',
    'tasks.status.success': '已就绪',
    'tasks.status.error': '失败',
    'tasks.item.format': '{format} 转换',
    'tasks.item.generic': '后台任务',
    'tasks.item.source': '来源：{source}',
    'tasks.item.book': '书籍 ID：{id}',
    'tasks.item.bookTitle': '书名：{title}',
    'webdav.title': 'WebDAV 书库',
    'webdav.signin.helper': '请登录以管理 WebDAV 连接。',
    'webdav.signin.cta': '前往登录',
    'webdav.overline': '存储',
    'webdav.subtitle': '添加 WebDAV 服务器以索引并流式读取书库。',
    'webdav.refresh': '刷新',
    'webdav.form.add': '添加连接',
    'webdav.form.edit': '编辑连接',
    'webdav.form.baseUrl': '基础地址',
    'webdav.form.baseUrl.placeholder': 'https://dav.example.com/remote.php/dav/files/user',
    'webdav.form.username': '用户名',
    'webdav.form.username.placeholder': 'user',
    'webdav.form.secret': '密码 / 应用令牌',
    'webdav.form.secret.placeholder': '••••••••',
    'webdav.form.save': '保存连接',
    'webdav.form.update': '更新连接',
    'webdav.form.cancel': '取消编辑',
    'webdav.form.tip': '提示：部分服务需要应用专用密码。',
    'webdav.list.title': '连接',
    'webdav.list.loading': '加载中…',
    'webdav.list.empty': '暂无连接，添加一个开始使用。',
    'webdav.list.lastSync': '上次同步 {time}',
    'webdav.action.sync': '同步',
    'webdav.action.edit': '编辑',
    'webdav.action.remove': '移除',
    'webdav.status.idle': '空闲',
    'webdav.status.success': '成功',
    'webdav.status.error': '错误',
    'webdav.status.syncing': '同步中',
    'webdav.message.loadError': '无法加载 WebDAV 连接。',
    'webdav.message.saveError': '无法保存连接，请检查信息。',
    'webdav.message.removeError': '无法移除此连接。',
    'webdav.message.syncStart': '已开始同步，稍后刷新查看更新。',
    'webdav.message.syncError': '无法开始同步。',
    'reader.quick.theme': '主题',
    'reader.quick.layout': '布局',
    'reader.quick.focus': '专注',
    'reader.quick.settings': '设置',
    'reader.controls.title': '自定义',
    'reader.controls.reset': '重置',
    'reader.controls.preset': '预设',
    'reader.controls.preset.custom': '自定义',
    'reader.controls.customPresets.title': '自定义预设',
    'reader.controls.customPresets.subtitle': '保存当前设置。',
    'reader.controls.customPresets.placeholder': '预设名称',
    'reader.controls.customPresets.save': '保存',
    'reader.controls.customPresets.empty': '暂无自定义预设。',
    'reader.controls.customPresets.apply': '应用',
    'reader.controls.customPresets.rename': '重命名',
    'reader.controls.customPresets.delete': '删除',
    'reader.controls.scope': '仅应用于本书',
    'reader.controls.theme.label': '主题',
    'reader.controls.theme.paper': '纸张',
    'reader.controls.theme.sepia': '棕褐',
    'reader.controls.theme.night': '夜间',
    'reader.controls.theme.slate': '石板',
    'reader.controls.theme.mist': '薄雾',
    'reader.controls.background.title': '背景',
    'reader.controls.background.subtitle': '想要自定义色调可覆盖主题。',
    'reader.controls.background.swatch': '背景 {label}',
    'reader.controls.background.custom': '自定义背景色',
    'reader.controls.background.useTheme': '使用主题',
    'reader.controls.brightness': '亮度',
    'reader.controls.font.label': '字体',
    'reader.controls.font.serif': '衬线',
    'reader.controls.font.sans': '无衬线',
    'reader.controls.font.mono': '等宽',
    'reader.controls.fontSize': '字号',
    'reader.controls.lineHeight': '行高',
    'reader.controls.readingPace': '阅读速度',
    'reader.controls.readingPace.value': '{value} 词/分钟',
    'reader.controls.pageWidth': '页面宽度',
    'reader.controls.alignment.label': '对齐',
    'reader.controls.alignment.left': '左对齐',
    'reader.controls.alignment.justify': '两端对齐',
    'reader.controls.layout.label': '布局',
    'reader.controls.layout.single': '单栏',
    'reader.controls.layout.columns': '分栏',
    'reader.controls.focusMode': '专注模式',
    'reader.presets.paper': '纸张专注',
    'reader.presets.sepia': '棕褐安静',
    'reader.presets.night': '夜间工作室',
    'reader.presets.slate': '石板专注',
    'reader.presets.mist': '薄雾日光',
    'reader.presets.comfort': '舒适增强',
    'reader.meta.time': '剩余 {left} 分钟 · 共 {total} 分钟',
    'reader.progress.label': '阅读进度',
    'reader.text.empty': '未找到文本内容。',
    'reader.bookmarks.title': '书签',
    'reader.bookmarks.subtitle': '保存阅读位置，方便快速跳转。',
    'reader.bookmarks.label': '书签标题',
    'reader.bookmarks.placeholder': '书签标题',
    'reader.bookmarks.add': '添加',
    'reader.bookmarks.empty': '暂无书签。',
    'reader.bookmarks.remove': '移除',
    'reader.bookmarks.defaultLabel': '书签 {percent}%',
    'reader.page.overline': '阅读',
    'reader.page.title': '阅读空间',
    'reader.page.shortcuts': '快捷键',
    'reader.page.settings': '设置',
    'reader.page.exitFocus': '退出专注',
    'reader.shell.notFound': '未找到图书。',
    'reader.format.epub': 'EPUB 阅读器：{title}',
    'reader.format.pdf': 'PDF 阅读器：{title}',
    'reader.format.mobi': 'MOBI 阅读器：{title}。若解析失败，请使用服务器转换。',
    'reader.shortcuts.aria': '阅读快捷键',
    'reader.shortcuts.title': '快捷键',
    'reader.shortcuts.close': '关闭',
    'reader.shortcuts.hint': '按 Esc 关闭。',
    'reader.shortcuts.cycleTheme': '切换主题',
    'reader.shortcuts.toggleLayout': '切换布局',
    'reader.shortcuts.focusMode': '专注模式',
    'reader.shortcuts.settings': '设置面板',
    'reader.shortcuts.increaseFont': '增大字号',
    'reader.shortcuts.decreaseFont': '减小字号',
    'reader.shortcuts.show': '显示快捷键',
    'placeholder.format': '格式：{format}',
    'placeholder.comic': '检测到漫画归档，渲染支持已排队。',
    'placeholder.kindle': '检测到 Kindle 格式，转换支持已排队。',
    'placeholder.fb2': '检测到 FictionBook 格式，解析支持已排队。',
    'placeholder.rtf': '检测到 RTF 格式，解析支持已排队。',
    'placeholder.docx': '检测到 Word 文档，解析支持已排队。',
    'placeholder.markdown': '检测到 Markdown 文档，渲染支持已排队。',
    'placeholder.html': '检测到 HTML 文档，渲染支持已排队。',
    'placeholder.odt': '检测到 OpenDocument 文本，渲染支持已排队。',
    'placeholder.djvu': '检测到 DjVu 文档，渲染支持已排队。',
    'placeholder.xps': '检测到 XPS 文档，渲染支持已排队。',
    'placeholder.lit': '检测到微软 Reader 格式，转换支持已排队。',
    'placeholder.pdb': '检测到 PalmDOC 格式，转换支持已排队。',
    'placeholder.unsupported': '该格式暂不支持。',
    'placeholder.note': '文件已安全索引，渲染就绪后将通知你。',
    'pwa.title': '安装 Relite Reader',
    'pwa.description.install': '添加到主屏幕，支持离线阅读。',
    'pwa.description.ios': '在 iOS Safari 中点按分享 → 添加到主屏幕。',
    'pwa.action.install': '安装',
    'pwa.action.dismiss': '稍后',
  },
}

const interpolate = (template: string, vars?: Record<string, string | number>) => {
  if (!vars) return template
  return template.replace(/\{(\w+)\}/g, (match, key) => {
    const value = vars[key]
    return value === undefined ? match : String(value)
  })
}

export function I18nProvider({ children }: { children: React.ReactNode }) {
  const [locale, setLocaleState] = useState<Locale>(() => getStoredLocale() ?? detectLocale())

  useEffect(() => {
    saveLocale(locale)
    if (typeof document !== 'undefined') {
      document.documentElement.lang = locale
    }
  }, [locale])

  const t = useMemo(() => {
    return (key: string, vars?: Record<string, string | number>) => {
      const template = translations[locale]?.[key] ?? translations.en[key] ?? key
      return interpolate(template, vars)
    }
  }, [locale])

  const value = useMemo(
    () => ({
      locale,
      setLocale: setLocaleState,
      t,
    }),
    [locale, t],
  )

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>
}

export function useI18n() {
  const ctx = useContext(I18nContext)
  if (!ctx) {
    throw new Error('useI18n must be used within I18nProvider')
  }
  return ctx
}
