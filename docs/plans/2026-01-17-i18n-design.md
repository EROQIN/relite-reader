# Relite Reader i18n (English + Chinese) Design

**Goal:** Add multi-language support to the frontend (English + Chinese) with automatic language detection, manual switching, and persistence (local and server-side) while keeping the reader UI clean and calm.

## Context
- Frontend is React + Vite with React Router.
- Preferences exist for reader settings and are persisted locally; server preferences endpoint exists.
- The app already includes Chinese-friendly fonts in CSS.

## Requirements
- Detect language from the browser and default to English if unsupported.
- Allow users to manually switch language in the UI.
- Persist language preference:
  - Logged-out: localStorage
  - Logged-in: server preferences (PostgreSQL-backed when configured)
- Translate all user-facing strings for primary pages and the reader controls.
- Keep the UI minimal and uncluttered, especially in the reader.

## Proposed Architecture
### Frontend i18n layer
Use a lightweight in-app i18n module with:
- A translation dictionary keyed by semantic IDs (e.g., `nav.library`).
- A `t(key, vars?)` helper for interpolation.
- A `LocaleContext` (provider + hook) that exposes `locale`, `setLocale`, and `t`.
- Language persistence in `localStorage` and optional server sync via preferences API.

Why this approach:
- Minimal runtime overhead.
- Full control over translations and fallbacks.
- Easy to expand later to a library if needed.

### Backend preferences extension
Extend `UserPreferences` with a `locale` field and normalization:
- Allowed locales: `en`, `zh-CN` (with `zh` normalized to `zh-CN`).
- Default to `en` when invalid or missing.
This uses the existing `/api/preferences` endpoint and Postgres/File/Memory stores.

## Data Flow
1. App boot:
   - Read `relite.locale` from localStorage if present.
   - Else detect from `navigator.language` and normalize to supported locales.
2. If user is logged in:
   - Fetch `/api/preferences`.
   - If `locale` is present and differs, update locale and store it locally.
3. When user changes language:
   - Update context + `document.documentElement.lang`.
   - Persist to localStorage.
   - If logged in, persist `locale` via `/api/preferences`.
4. Reader preferences saves must include current `locale` to avoid overwriting.

## UI Changes
- Add a compact language selector in the app header (e.g., "EN / 中文").
- Use translations for:
  - Navigation items
  - Auth flow text and messages
  - Library states and buttons
  - WebDAV setup guidance
  - Reader controls, presets, tooltips, and empty states
- Keep the reader view uncluttered: language switcher stays in the top nav only.

## Testing Strategy (TDD)
Frontend:
- Unit tests for locale detection and persistence.
- Component tests for rendering translated labels and switching language.
- Ensure `document.documentElement.lang` updates.

Backend:
- Update preferences tests to include locale normalization and persistence.

## Migration / Compatibility
- Existing preferences without `locale` will default to `en`.
- Clients sending only `reader` preferences will still be accepted; new clients must include `locale` to avoid overwriting.

## Non-Goals
- No per-book locale.
- No RTL layout support (future).

